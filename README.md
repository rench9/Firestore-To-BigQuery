# Cloud Firestore To BigQuery
## Prerequisite
* [Enable billing for your Google Cloud Platform](https://cloud.google.com/billing/docs/how-to/modify-project) project. Only GCP projects with billing enabled can use the export and import functionality.
* [Create a Cloud Storage bucket for your project](https://github.com/rench9/Firestore-To-BigQuery#create-a-new-storage-bucket) in a location near your Cloud Firestore database location `(It must be in the same regional or multi-regional location )`. You cannot use a Requester Pays bucket for export and import operations.
* If you are the project owner, your account has the required permissions, else make sure you following rights granted:
  * Cloud Firestore roles: Owner, Cloud Datastore Owner, or Cloud Datastore Import Export Admin
  * Cloud Storage roles: Owner or Storage Admin

## Create a new storage bucket:
* [Open the Cloud Storage browser](https://console.cloud.google.com/storage/browser?_ga=2.67414481.-1186296064.1537376599&_gac=1.45420560.1544978012.EAIaIQobChMI1LWQ4eCk3wIVzDUrCh2HuQk2EAAYASAAEgLEFPD_BwE) in the Google Cloud Platform Console.
* Click `Create bucket`.
* Specify a `Name`, subject to the bucket name requirements.
* Select a `Default storage class` for the bucket. The default storage class will be assigned by default to all objects uploaded to the bucket.
A `Location` where the bucket data will be stored, this is crucial.
   > Your dataset must be in the same regional or multi-regional location as the Cloud Storage bucket containing your export files.

Click `Create`.

## gCloud setup
* Access gcloud from the Google Cloud Platform console using [Cloud Shell](https://cloud.google.com/shell/).
* Make sure gcloud is configured for the correct project:   
  >```gcloud config set project [PROJECT_ID]```  
  > Sample:  
  >```gcloud config set project sample-proj-1234```  

Make sure you have gCloud beta components instated and up to date  
```gcloud components install beta```

### Now the actual export
Use the firestore export command to export all the documents in your database, replacing [BUCKET_NAME] with the name of your Cloud Storage bucket  
>```gcloud beta firestore export gs://[BUCKET_NAME] --collection-ids=[COLLECTION_ID_1],[COLLECTION_ID_2]```  
>Sample:  
>```gcloud beta firestore export gs://sample-proj-1234-bucket --collection-ids='users','cart'```  

## Export to BigQuery From Cloud Firestore Exports
* Go to the [BigQuery web UI](https://bigquery.cloud.google.com/).
* In the navigation panel, hover on a dataset, click the down arrow icon and click `Create new table`.
* On the `Create Table` page, in the `Source Data` section:
  * Leave `Create from source` selected.
  * For `Location`, select `Google Cloud Storage` and in the source field, enter the Cloud Storage URI. The Cloud Storage bucket must be in the same location as your dataset. The URI for your Cloud Firestore export file should end with `[KIND_COLLECTION_ID].export_metadata`. For example: `users_namespace_kind_id.export_metadata`. In this example, `Book` is the collection ID, and `default_namespace_kind_Book` is the file name generated by Cloud Firestore.
  * For `File format`, select `Cloud Datastore Backup`. Cloud Datastore Backup is the correct option for Cloud Firestore. Cloud Firestore and Cloud Datastore share an export format.
* On the `Create Table` page, in the `Destination Table` section
  * For `Table name`, choose the appropriate dataset, and in the table name field, enter the name of the table you're creating in BigQuery.
  * Verify that `Table` type is set to `Native table`.
* In the `Schema` section, no action is necessary. The schema is inferred for a Cloud Firestore export.
* Select applicable items in the Options section. If you are overwriting an existing table, set `Write preference` to `Overwrite table`.
* Click `Create Table`.

## Visualizing BigQuery Data Using Google Data Studio
[Create reports and charts using Google Data Studio and the BigQuery connector](https://cloud.google.com/bigquery/docs/visualize-data-studio#create_reports_and_charts_using_google_data_studio_and_the_bigquery_connector)
